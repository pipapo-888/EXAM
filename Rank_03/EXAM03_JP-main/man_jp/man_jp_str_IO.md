# STDIO(3) — Linux Programmer's Manual

## 名前
stdio — 標準入出力ライブラリの概要

## 説明
C 言語の標準入出力ライブラリ (`<stdio.h>`) は、ファイル、デバイス、端末などのストリーム型 I/O を扱うための高水準 API を提供する。  
これにより、プログラムはデータの読み書きを一貫した抽象インターフェースを通して実行できる。

主な特徴：
- ファイルディスクリプターに対するバッファリング（性能向上）
- フォーマット付き I/O (`printf(3)`, `scanf(3)`)
- エラー検出 (`ferror(3)`, `perror(3)`)
- ストリーム位置指定 (`fseek(3)`, `ftell(3)`, `rewind(3)`)
- スレッドセーフな I/O

## 標準ストリーム
プロセス開始時に以下の 3 つのストリームが自動的に開かれる：

| ストリーム | 用途 | ファイルディスクリプター |
|-------------|------|---------------------------|
| `stdin`  | 標準入力 | 0 |
| `stdout` | 標準出力 | 1 |
| `stderr` | 標準エラー出力 | 2 |

これらは `FILE *` 構造体として定義され、通常はターミナルに接続される。  
`stderr` はデフォルトで **無バッファ**、`stdin` と `stdout` は **行バッファ** もしくは **全バッファ** モードで動作する。

## バッファリング
`stdio` では入出力性能向上のためにデータがバッファに蓄えられる。  
`setvbuf(3)` や `setbuf(3)` によって制御できる。  
バッファモードの種類：

| モード | 説明 |
|--------|------|
| `_IONBF` | 無バッファ（即時書き込み） |
| `_IOLBF` | 行バッファ（改行または入力待ちでフラッシュ） |
| `_IOFBF` | 全バッファ（バッファ満杯または明示的フラッシュで書き込み） |

`fflush(3)` により明示的にフラッシュを行える。

## 主な関数群
| カテゴリ | 関数例 |
|-----------|--------|
| ファイル操作 | `fopen(3)`, `freopen(3)`, `fclose(3)` |
| 文字 I/O | `fgetc(3)`, `fputc(3)`, `getc(3)`, `putc(3)` |
| 行 I/O | `fgets(3)`, `fputs(3)`, `puts(3)` |
| フォーマット I/O | `printf(3)`, `fprintf(3)`, `scanf(3)` |
| バッファ制御 | `fflush(3)`, `setvbuf(3)` |
| 位置指定 | `fseek(3)`, `ftell(3)`, `rewind(3)` |
| エラー処理 | `ferror(3)`, `feof(3)`, `clearerr(3)` |

## ストリームとファイルディスクリプター
`stdio` は内部的にファイルディスクリプター（`int fd`）を保持し、低レベルのシステムコール（`read(2)`, `write(2)`, `lseek(2)`）を呼び出す。
`fileno(3)` で `FILE *` からファイルディスクリプターを取得でき、`fdopen(3)` で逆変換できる。

ただし、同一ファイル記述子を複数の `FILE *` が共有する場合、バッファリングの同期に注意が必要である。
たとえば、`write(2)` を直接呼び出した後は、対応するストリームを `fflush()` または `fseek()` して同期を取るべきである。

## エラー管理
すべてのストリームは「エラー指示子」と「EOF指示子」を持つ。  
- `ferror(3)`：エラー状態の確認  
- `feof(3)`：EOF 状態の確認  
- `clearerr(3)`：両指示子のクリア

また、`perror(3)` や `strerror(3)` により `errno` の内容を可読メッセージとして表示できる。

## 属性
| インタフェース | 属性 | 値 |
|---|---|---|
| `stdio` 関数群 | スレッド安全性 | MT-Safe locale |

## 準拠
C89, C99, POSIX.1-2001, POSIX.1-2008 に準拠。

## 注記（NOTES）
- `stdio` の関数は内部状態を保持するため、ファイルディスクリプターを直接操作するときは同期が必要である。  
- `dup2(2)` や `pipe(2)` と組み合わせる場合、`fflush(3)` を使ってバッファの内容を明示的に出力するのが安全である。
- 多くの実装では、`stdio` はロケール依存の変換（特にワイド文字 I/O）を行う。

## 関連項目
`fopen(3)`, `fclose(3)`, `printf(3)`, `scanf(3)`, `ferror(3)`, `setvbuf(3)`, `dup2(2)`, `pipe(2)`

## コロフォン（COLOPHON）
このページは Linux man-pages プロジェクトの一部である。プロジェクトの説明、バグ報告、および最新版の入手方法については：  
<https://www.kernel.org/doc/man-pages/>

---

## 解説（実務的補足）
- `stdio` は低レベル I/O に対する安全で移植性の高い抽象化レイヤである。  
- パフォーマンスを最大化するには、適切なバッファモード設定（`setvbuf()`）が重要。  
- バッファリングを誤用すると、ログ出力が遅延したり、プロセス間通信で同期ズレが発生する可能性がある。  
- 高スループットなアプリケーションでは、`stdio` の上でさらに非同期 I/O（`aio(7)` など）を組み合わせる手法もある。
