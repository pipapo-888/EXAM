# MEMCPY(3) — Linux Programmer's Manual

## 名前
memcpy — メモリ領域のコピーを行う

## 書式
```c
#include <string.h>

void *memcpy(void *dest, const void *src, size_t n);
```

## 説明
`memcpy()` 関数は、`src` が指すメモリ領域から `n` バイトを `dest` が指すメモリ領域にコピーする。
コピー元とコピー先のメモリ領域は **重なってはならない**。
重なっている場合の動作は **未定義** であり、そのような場合は `memmove(3)` を使用すること。

これらの関数は高速なメモリ転送を行うが、重複領域に対しては動作の保証がないため、使用時には十分な注意が必要である。

## 返り値
成功時、`memcpy()` は `dest` を返す。

## 属性
| インタフェース | 属性 | 値 |
|----------------|------|----|
| `memcpy()` | スレッド安全性 | MT-Safe |

## 準拠
POSIX.1-2001, POSIX.1-2008, C89, C99, SVr4, 4.3BSD に準拠。

## 注記（NOTES）
メモリ領域が重なってはならないという要件を無視した場合、深刻なバグの原因となる。
C 標準では、重なりを持つメモリ領域のコピーは明示的に **未定義動作** として規定されている。

glibc では、バージョン 2.14 以降 `memcpy()` の実装が変更され、重複領域を安全にコピーしなくなった（以前は `memmove()` のように動作する場合があった）。
この変更により、古いバイナリ（glibc 2.13 以前でコンパイルされたもの）では非互換性が発生する可能性がある。

古いシステムでは、`memcpy()` がオーバーラップ領域を安全に扱うと仮定していたアプリケーションが存在したが、現在の実装ではそれは保証されない。
したがって、互換性や移植性を考慮する場合は **常に `memmove()` を使用する** ことが推奨される。

## 関連項目
`bcopy(3)`, `bstring(3)`, `memccpy(3)`, `memmove(3)`, `mempcpy(3)`, `strcpy(3)`, `strncpy(3)`, `wmemcpy(3)`

## コロフォン（COLOPHON）
このページは Linux man-pages プロジェクト（リリース 5.10）の一部である。
プロジェクトの説明、バグ報告の方法、および最新版の入手については次のURLを参照：
<https://www.kernel.org/doc/man-pages/>

---

## 解説（実務的補足）

### 1. 実装概要
`memcpy()` は典型的には以下のように実装される：
```c
void *memcpy(void *dest, const void *src, size_t n) {
    unsigned char *d = dest;
    const unsigned char *s = src;
    while (n--) *d++ = *s++;
    return dest;
}
```
実際の glibc 実装では、CPU ごとに最適化されたアセンブリ版（x86 なら `rep movsb`）が使われる。

### 2. glibc 2.14 の仕様変更
glibc 2.14 以降は、`memcpy()` と `memmove()` の内部実装が完全に分離された。
以前はオーバーラップ検出を行い安全コピーを行う場合があったが、現在は純粋な「非重複コピー関数」として動作する。

### 3. 開発時の注意点
| 状況 | 安全な関数 |
|------|-------------|
| コピー元・先が明確に分離している | `memcpy()` |
| 重複の可能性がある | `memmove()` |
| バッファサイズが動的で安全性が必要 | `memcpy_s()` (C11 Annex K) |

### 4. 性能面
glibc は CPU 特性に応じて、SSE2 / AVX / REP MOVSB などを自動選択し、大きな転送ではキャッシュライン整合を考慮している。
非アラインアクセスでも整合性を保つよう設計されている。

### 5. まとめ
- 重複領域では使用禁止（未定義動作）。
- glibc 2.14 以降、旧挙動を仮定しない。
- メモリコピーはハードウェア最適化が強く影響するため、必要ならベンチマークで検証する。

*原文: Linux man-pages project version 5.10 — memcpy(3)*
